#!/bin/bash

set -e

#CODESCALE_DIR="$HOME/.codescale"
CODESCALE_DIR="$(dirname "$0")/instances"
TEMPLATE_DIR="$(dirname "$0")/template"
declare -A IMAGE_MAP=(
  ["all"]="lazyzeus/ubuntu-all:24.04"
  ["dockerd"]="lazyzeus/ubuntu-dockerd:24.04"
  ["systemd"]="lazyzeus/ubuntu-systemd:24.04"
)

print_usage() {
    echo "Usage: codescale <command> [args]"
    echo ""
    echo "Commands:"
    echo "  init  <workspacename> <image>  Create new workspace with specified template"
    echo "  start <workspacename> [options]   Start workspace containers"
    echo "  stop  <workspacename>             Stop workspace containers"
    echo "  reset <workspacename>             Delete workspace"
    echo "  list                              List all workspaces"
    echo "  template                          List all available templates"
    echo ""
}

init_workspace() {
    local workspace_name="$1"
    local image="$2"

    if [[ -z "$workspace_name" ]]; then
        echo "Error: Workspace name required"
        echo "Usage: codescale init <workspacename> <template>"
        exit 1
    fi

    if [[ -z "$image" ]]; then
        image="all"
    fi

    local workspace_dir="$CODESCALE_DIR/$workspace_name"
    local image_name="${IMAGE_MAP[$image]}"

    if [[ -d "$workspace_dir" ]]; then
        echo "Error: Workspace '$workspace_name' already exists"
        exit 1
    fi

    echo "Creating workspace '$workspace_name' with image '$image_name'..."
    mkdir -p "$workspace_dir"

    cp -r "$TEMPLATE_DIR"/. "$workspace_dir/"

    echo "COMPOSE_PROJECT_NAME=$workspace_name" >> $workspace_dir/.env
    echo "BAKE_IMAGE_NAME=$image_name" >> $workspace_dir/.env

    echo "Workspace '$workspace_name' created successfully at $workspace_dir"
}

start_workspace() {
    local workspace_name="$1"
    shift  # Remove workspace name from arguments
    local additional_args="$@"  # Capture remaining arguments

    if [[ -z "$workspace_name" ]]; then
        echo "Error: Workspace name required"
        echo "Usage: codescale start <workspacename> [options]"
        exit 1
    fi

    local workspace_dir="$CODESCALE_DIR/$workspace_name"

    if [[ ! -d "$workspace_dir" ]]; then
        echo "Error: Workspace '$workspace_name' does not exist"
        exit 1
    fi

    echo "Starting workspace '$workspace_name'..."
    pushd "$workspace_dir" > /dev/null
    docker compose up -d $additional_args
    popd > /dev/null
    echo "Workspace '$workspace_name' started successfully"
}

stop_workspace() {
    local workspace_name="$1"

    if [[ -z "$workspace_name" ]]; then
        echo "Error: Workspace name required"
        echo "Usage: codescale stop <workspacename>"
        exit 1
    fi

    local workspace_dir="$CODESCALE_DIR/$workspace_name"

    if [[ ! -d "$workspace_dir" ]]; then
        echo "Error: Workspace '$workspace_name' does not exist"
        exit 1
    fi

    echo "Stopping workspace '$workspace_name'..."
    pushd "$workspace_dir" > /dev/null
    docker compose down
    popd > /dev/null
    echo "Workspace '$workspace_name' stopped successfully"
}

reset_workspace() {
    local workspace_name="$1"

    if [[ -z "$workspace_name" ]]; then
        echo "Error: Workspace name required"
        echo "Usage: codescale reset <workspacename>"
        exit 1
    fi

    local workspace_dir="$CODESCALE_DIR/$workspace_name"

    if [[ ! -d "$workspace_dir" ]]; then
        echo "Error: Workspace '$workspace_name' does not exist"
        exit 1
    fi

    echo "Stopping and removing workspace '$workspace_name'..."
    pushd "$workspace_dir" > /dev/null
    docker compose down -v 2>/dev/null || true
    popd > /dev/null
    rm -rf "$workspace_dir"
    echo "Workspace '$workspace_name' reset successfully"

    # https://tailscale.com/api#tag/devices/delete/device/{deviceId}
    workspace_device_id=$(tailscale status --json | jq -r --arg host "$workspace_name" '(.Self, .Peer[]?) | select(.HostName==$host) | .ID')
    if [ -n $workspace_device_id ]; then
        result=$(curl -s "https://api.tailscale.com/api/v2/device/$workspace_device_id" --request DELETE --header 'Authorization: Bearer tskey-api-kkXLGDaHns11CNTRL-xoPpXZ9vq91ebY3JmE9n91S3b7znqGh6')
        if [ "$result" == "null" ]; then
            echo $workspace_name has been deleted from the tailscale network.
        else 
            echo "$result"
        fi
    fi
}

list_workspaces() {
    echo "CodeScale Workspaces:"
    echo "===================="

    if [[ ! -d "$CODESCALE_DIR" ]]; then
        echo "No workspaces found"
        return
    fi

    for workspace_dir in "$CODESCALE_DIR"/*; do
        if [[ -d "$workspace_dir" ]]; then
            local workspace_name=$(basename "$workspace_dir")
            local status="STOPPED"

            if [[ -f "$workspace_dir/docker-compose.yml" ]]; then
                pushd "$workspace_dir" > /dev/null
                if docker compose ps -q | grep -q .; then
                    if docker compose ps | grep -q "Up"; then
                        status="RUNNING"
                    fi
                fi
                popd > /dev/null
            fi

            printf "%-20s %s\n" "$workspace_name" "$status"
        fi
    done
}

list_images() {
    echo "Available Images"
    echo "==================="

    for key in "${!IMAGE_MAP[@]}"; do
      printf "%-10s = %s\n" "$key" "${IMAGE_MAP[$key]}"
    done
}

case "$1" in
    init)
        init_workspace "$2" "$3"
        ;;
    start)
        shift  # Remove 'start' command
        start_workspace "$@"
        ;;
    stop)
        stop_workspace "$2"
        ;;
    reset)
        reset_workspace "$2"
        ;;
    list)
        list_workspaces
        ;;
    image)
        list_images
        ;;
    help|--help|-h)
        print_usage
        ;;
    "")
        print_usage
        ;;
    *)
        echo "Error: Unknown command '$1'"
        print_usage
        exit 1
        ;;
esac
